<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta content="yes" name="apple-mobile-web-app-capable">
<link rel="apple-touch-icon" sizes="120x120" href="assets/apple-touch-icon-120x120.png" />
<link rel="apple-touch-icon" sizes="152x152" href="assets/apple-touch-icon-152x152.png" />
<link rel="icon" type="image/png" sizes="32x32" href="assets/favicon-32x32.png">
<link rel="shortcut icon" href="assets/favicon.ico">
<meta content="width=device-width,initial-scale=1,maximum-scale=1.0,user-scalable=no" name="viewport">
<meta content="Faisal Akhtar, Shubhangi Goyal" name="author">
<title>LOGIN</title>
<link rel="stylesheet" type="text/css" href="static/basic.css">
<link rel="stylesheet" type="text/css" href="static/login.css">
</head>

<body>
<main>
	<h2>LOGIN HERE BUDDY</h2>
	<form onsubmit="return formHandler(this)">
		<input name="username" type="text" placeholder="Enter your username" autofocus>
		<input name="password" type="password" placeholder="Enter your password">
		<input type="submit" value="LOGIN">
	</form>
	<p>&copy; Faisal Akhtar</p>
</main>

<script>
window.onload = function() {
	let xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function () {
		if (this.readyState != 4) return;

		let data = JSON.parse(this.responseText);
		if (this.status == 200) {
			alert(data.message)
			window.location.href = `${location.protocol}//${location.host}/app`;
		}
		console.log(data)
	};
	xhr.open("GET", "/login", true);
	xhr.send();
}

function formHandler(form) {
	let x = serializeObj(form)
	console.log("x")

	let xhr = new XMLHttpRequest();
	xhr.onreadystatechange = function () {
		if (this.readyState != 4) return;

		if (this.status == 200) {
			let data = JSON.parse(this.responseText);
			if(data.status==1) {
				alert(data.message)
				window.location.href = `${location.protocol}//${location.host}/app?welcome=true`;
			} else {
				alert(data.message)
			}

			console.log(data)
		}
	};
	xhr.open("POST", "/login", true);
	xhr.setRequestHeader('Content-Type', 'application/json');
	xhr.send(JSON.stringify({
		username: x.username,
		password: x.password
	}));

	return false;
}

var serializeObj = function (form) {
	let obj = {};
	Array.prototype.slice.call(form.elements).forEach(function (field) {
		if (!field.name || field.disabled || ['file', 'reset', 'submit', 'button'].indexOf(field.type) > -1) return;
		if (field.type === 'select-multiple') {
			Array.prototype.slice.call(field.options).forEach(function (option) {
				if (!option.selected) return;
				obj[field.name] = option.value;
			});
			return;
		}
		if (['checkbox', 'radio'].indexOf(field.type) >-1 && !field.checked) return;
		obj[field.name] = field.value;
	});
	return obj;
};
</script>
</body>
</html>